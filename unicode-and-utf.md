# Unicode 与 UTF 的关系
## 字符集与字符编码
为了在计算机中表示我们平时写的字符（如数字0、1、2，字母a、b、c、A、B、C，标点符号，汉字等），需要对这些字符进行编码，即在计算机中用特定的字节序列表示这些字符，这涉及字符集与字符编码两个概念。

**字符集**（Charset）是一组字符（如文字/字母、数字、标点符号、图形符号等）集合，并规定每个字符对应的**码位**（Code Point，或称码点，即每个字符对应的一个唯一的整数ID）。

**字符编码**（Character Encoding）是**把字符集中的字符的码位，按一定的规则转换成计算机系统中的字节序列**，便于计算机处理与网络传输。根据编码方式的不同，每个字符对应的字节序列可能是单个或多个字节。

通常来说，**一种字符集只对应一种字符编码**，比如`ASCII`、`IOS-8859-1`、`GBK`等既表示了字符集，又表示了对应的字符编码。但是Unicode有所不同，它的字符集（Unicode字符集）对应了多种字符编码（UTF-8、UTF-16、UTF-32）。

## 字符集发展小史

#### 美国的 ASCII 字符集
最初，计算机在美国被使用时，由于英文的只有26个字母，算上大小写即其他符号，字符数也不多，于是只需要7个bit（可表示128个字符）就足够了。于是出现了最初的`ASCII`字符集，该字符集用0~127，共128个码位来表示128个字符。在计算机中具体应用起来也比较简单，一个字符仅用一个字节即可表示，且只用到了一个字节的低7位，其最高位始终置为0。

`ASCII`字符集的全称是 American Standard Code for Information Interchange（美国信息交换标准代码），等同于国际标准的`ISO/IEC 646`字符集。

#### 欧洲的 ISO-8859 字符集
後来，欧洲开始使用计算机，发现他们用的一些字符并不在`ASCII`字符集中，需要对`ASCII`进行扩充，形成了`ISO-8859`字符集。由于欧洲的语言环境也很复杂，所以根据各地区的语言形成了很多子标准，出现了一系列的`ISO-8859`字符集，如`ISO-8859-1`是西欧语言字符集，`ISO-8859-2`是中欧语言字符集。

`ISO-8859`字符集也只用一个字节编码字符，但扩展了ASCII中单字节最高位的含义：**字节的最高位为1时，用来标识那些新增的拉丁字母与西里尔字母等；而最高位为0时，含义等同于ASCII字符集**。由于这一系列字符集的标准，是由国际标准化组织(ISO)与国际电工委员会(IEC)联合制定的，所以`ISO-8859`更正式的名称是`ISO/IEC 8859`。

#### 汉字的字符集
汉字有多种字符集，而且由于汉字的字符数量非常多，无法用一个字节（只有256种不同取值）来表示这么的汉字，因此其编码是基于多个字节的。
在中国大陆，汉字的主要字符集包括：
1. 首先是1980年发布的`GB2312`编码方案，收录汉字6763个和非汉字图形字符682个，使用1~2个字节编码，兼容`ASCII`字符集。
1. 接着是1995年发布的`GBK`（国标扩展）编码方案，向下与`GB2312`编码兼容，有23940个码位，共收录21003个汉字（包括传统繁体字）。使用1~2个字节编码，兼容`ASCII`字符集。
1. 以及2000年发布的`GB18030`，收录汉字70244个，其对`GB2312`完全兼容，与`GBK`基本兼容，并支持`Unicode(GB13000)`的所有码位。使用1、2或4个字节编码，兼容`ASCII`字符集。
1. 在台湾、香港与澳门等繁体中文（正体中文）通行区，用的较多的是俗称大五码的`Big5`字符集标准。

#### 遇到的问题
随着计算机在全世界的普及，出现的字符集越来越多，对字符的编码方式也各不相同。这样就造成不同国家采用不同的编码方式，为了解码一个字节序列，则必须知道它对应的编码方式，若用错了编码方式则解码时就会出现乱码。

随着字符集与编码方式的增多，对字节序列的解码，必须采用其特定的字符编码方式，这样既繁琐又容易弄错，不利于彼此的信息交流。为了统一世界范围内所有字符的编解码，于是出现了`Unicode`（统一码）字符集及其对应的编码方式。`Unicode`由Unicode联盟（Unicode Consortium）维护，研发始于1990年，1994年正式公布。

## Unicode字符集
`Unicode`字符集为每个字符分配一个唯一的数字编号即码位，码位的范围从`0x000000`到`0x10FFFF`。这些码位被划分成17个平面（Plane），每平面拥有65536个码位，故一共有65536 * 17 = 1114112个码位。`Unicode`目前只用了少数几个平面，收录了约15万个字符。

0号平面（又称BMP，Basic Multilingual Plane，基本多语言平面，基本平面）收录了最常用的字符，其码位范围为`0x0000 ~ 0xFFFF`。基本平面里的中日韩统一表意符号 (CJK Unified Ideographs)的码位范围为`0x4E00 ~ 0x9FBF`，其中的`0x4E00 ~ 0x9FA5`为汉字。剩下的屏幕称为SMP（Secondary Multilingual Plane，辅助多语言平面，辅助平面），码位范围从`U+010000`到`U+10FFFF`（数值`0x10FFFF`占用了21 bit）。

`Unicode`在表示一个字符时，通常以“`U+`”开头，後面跟着16进制的码位。如汉字“中”用`Unicode`表示为`U+4E2D`，其中16进制的4E2D的10进制值为20013，即20013这个码位在`Unicode`字符集中表示汉字“中”。

`Unicode`可分为字符集和编码方式两个层次，`Unicode`字符集只规定了每个字符的码位是多少，并没有规定这个码位在计算机中的编码方式。

## Unicode字符集的编码方式：UTF

可以用等长的字节对字符进行编码，即每个码位的所用的字节数是一样的，都等于最大码位所需的字节数（Unicode字符集的最大码位需用3个字节存储）。这种方式虽然简单，但占用的总字节数较多，尤其对于字符码位较小的英文文档，这种编码方式造成了存储空间的很大浪费。

另一种编码方式，则是对码位较小的字符（一般对使用频率高的字符赋予小的码位），用较少的字节编码，而对码位大的字符（其使用频率也较低），则采用较多的字节进行编码。这种编码方式占用的总字节数较少，但实施起来比较复杂（如怎么确定单个字符的字节边界等）。

Unicode的字符编码称为`UTF`(Unicode Transformation Format，直译为Unicode字符集转换格式) ，目前主要有3套编码方式，分别为UTF-8、UTF-16、UTF-32，它们分别以单个字节（8 bit）、2个字节（16 bit）、4个字节（32 bit）为编码的基本单位。

#### UTF-32 编码
UTF-32编码方式比较简单，直接用4个字节来表示每个Unicode字符的码位。4个字节共有32 bit，一共有2^32=4294967296个不同取值，用来表示1114112个码位没有问题。

#### UTF-16 编码
UTF-16以2个字节为基本单位，使用变长字节进行编码：
- 对于基本平面的字符（即码位在U+0000~U+FFFF之间），用2个字节表示。
- 对于辅助平面的字符（即码位在U+10000~U+10FFFF之间），则用4个字节表示。

对于基本平面中的字符，编码它们的2个字节值就是字符的Unicode码位。例如，汉字“中”的Unicode码位为U+4E2D，位于基本平面，故其UTF-16编码的为2字节的`0x4E2D`。

在Unicode字符集的码位分布中，有两个特殊的区段，0xD800 ~ 0xDBFF 和 0xDC00 ~ 0xDFFF。这两个区段的值并不用来作为字符的码位，而是用于识别UTF-16编码中，字节是2个还是4个作为一组来表示一个字符。
- 0xD800(二进制形式为1101_1000_0000_0000) ~ 0xDBFF(二进制形式为1101_1011_1111_1111)：该区段高位的6 bit固定为110110，低位的10 bit变化范围为0000000000~1111111111。
- 0xDC00(二进制形式为1101_1100_0000_0000) ~ 0xDFFF(二进制形式为1101_1111_1111_1111)：该区段高位的6 bit固定为110111，低位的10 bit变化范围为0000000000~1111111111。

辅助平面的码位范围是U+010000 到 U+10FFFF，故有0xFFFF+1=2^20个码位，表示这些字符只需20个bit。对于任意一个辅助平面中的码位，UTF-16编码步骤如下：
1. 将码位减去辅助平面的起始码位`0x010000`。
1. 得到的值若不足20 bit，则将其补足成20 bit。
1. 将这20个bit分成两半，前10位加上前缀`110110`，使其值位于`0xD800 ~ 0xDBFF`之间，作为高位的2字节组。
1. 后10位加上前缀`110111`，使其值位于在`0xDC00~0xDFFF`之间，作为低位的2字节组。

也就是说，辅助平面中字符的码位，被拆成了基本平面中的2个码位。设辅助平面的码位为C，则高码位H、低码位L的计算方式如下：
```
H = ((C - 0x10000) & 0b11111_11111_00000_00000) + 0xD800
L = ((C - 0x10000) & 0b00000_00000_11111_11111) + 0xDC00
```
注：上面式子中的`0b00000_00000_11111_11111`可以直接写成`0b11111_11111`。

计算机在处理UTF-16的编码字节时，以2个字节为一组。当前字节组若不在0xD800 ~ 0xDBFF之间，则该字节组的值即为一个Unicode码位，表示一个字符；若在0xD800 ~ 0xDBFF之间，则该字节组与後面的一个2字节组一起表示一个字符，其码位由前後字节组的低10个bit组合、运算後得到。

#### 辅助平面字符的UTF-16编码示例
汉字“𠄯”的Unicode码位是`0x2012F`，位于辅助平面，故其UTF-16需要4字节编码。将其减去`0x010000`後为`x1012F`，其二进制形式为`1_0000_0001_0010_1111`，补足成20 bit後为`00010_00000_01001_01111`。前10 bit加上前缀`110110`後为`1101_1000_0100_0000`，即高位的2字节组H=`0xD840`；後10 bit加上前缀`110111`後为`1101_1101_0010_1111`，即低位的2字节组L=`0xDD2F`。

#### 字节序
计算机在存储器中排列字节有的方式有两种，分别是大端法（Big Endian, BE）和小端法（Little Endian, LE）。大端法就是将高位字节放到低地址处，小端法则相反。

UTF-32和UTF-16根据字节排序方式的不同，其编码方式分为UTF-32BE、UTF-32LE 和 UTF-16BE、UTF-16LE。
由于UTF-8的处理单元为一个字节（也就是一次处理一个字节），所以处理器在处理的时候就不需要考虑这一个字节的存储是在高位还是在低位，直接拿到这个字节进行处理就行了，因为大小端是针对大于一个字节的数的存储问题而言的。

同样，UTF-16 也有字节的顺序问题（大小端），所以就有UTF-16BE表示大端，UTF-16LE表示小端。


下面详细叙述UTF-8编码方式。

## UTF-8
UTF-8是一种变长字节编码方式，也就是编码每个字符所用字节数不同，码位小的使用的字节就少，码位大的使用的字节就多。
#### 编码规则
根据每个字符的码位范围，UTF-8用1到4个字节来表示字符。

Unicode码位|10进制码位范围|编码形式|码位数量
-|-|-|-
U+000000 ~ U+00007F|[0, 127]|0XXXXXXX|128
U+000080 ~ U+0007FF|[128, 2047]|110XXXXX 10XXXXXX|1920
U+000800 ~ U+00FFFF|[2048, 65535]|1110XXXX 10XXXXXX 10XXXXXX|63488
U+010000 ~ U+10FFFF|[65536, 1114111]|11110XXX 10XXXXXX 10XXXXXX 10XXXXXX|1048576

表中“编码形式”一栏中，X代表字符码位的值。不论对于单字节或多字节的编码形式，将码位对应的二进制数从右向左依次填入二进制格式的X中。如果左边有X未填，则用0填充。

从表格可以看出：
1. 对于码位小于等于127的单字节字符，字节的首位为0，低7位为码位的值，此时UTF-8的编码方式是与ASCII相同的，即兼容ASCII编码。
1. 对于码位大于127的字符，其编码形式是多字节的。设字节数为N（N>1），则第1个字节的前N位都设为1，第N+1位设为0；后面N-1个字节的前2位均为10，剩余的位则按从右到左的顺序，填充上字符的码位值（不够则在左边补0）。

我们平时用得较多的汉字，其码位范围是`0x4E00 ~ 0x9FA5`，因此是3个字节编码的；部分生僻的汉字，以及表情符号等，则需4个字节编码。

#### 解码规则
UTF-8解码规则比较简单：
1. 如果当前字节的首位是0，则该字节单独对应一个字符。
1. 如果当前字节的首位是1，则看其连续1的数量，有多少个1就表示多少个字节共同对应着一个字符。将这些字节一并取出後，根据上述的编码规则，计算出字符的码位，从而就解码得到了相应的字符。

#### 编码示例
根据UTF-8的编码规则，下面具体计算一些字符的UTF-8编码。
- **当字符的码位落在区间[0, 127]时，则只用1个字节表示即可**。该字节最高位为0，低7位用来表示0~127这128个数值。

>> 如字母“a”的码位为U+0061（10进制值为97，2进制值为1100001），按UTF-8编码规则，在计算机中用 01100001（0x61） 这样1个字节表示。这其实就是`ASCII`字符集的范围。

- **当字符的码位落在区间[128, 2047]（共1920个值）时，则用2个字节表示**。第1个字节的高3位固定为110，剩余5位可变；第2个字节的高2位固定为10，剩余6位可变。因此一共有5+6=11位可变，有2^11=2048个不同取值（多于1920个），因此用来一一映射到[128, 2047]这些数是没问题的。

>> 如乘号标记×，其Unicode码位为U+00D7（10进制值为215，2进制值为11010111）。转换成UTF-8编码时，将11010111的低6位单独取出，为010111，前面加上10前缀，成为10010111，即16进制的0x97；剩余的高2位（11）补足成5位（00011），再加上前缀110後为11000011，即16进制的0xC3。因此乘号×的UTF-8表示法为2个字节，高字节为0xC3，低字节为0x97。

- **当字符的码位落在区间[2048, 65535]（共63488个值）时，则用3个字节表示**。第1个字节的高4位固定为1110，第2个字节的高2位固定为10，第3个字节的高2位固定为10。因此一共有4+6+6=16位可变，有2^16=65536个不同取值（多于63488个），因此用来一一映射[2048, 65535]这些数也不会有问题。

>> 如汉字“中”的Unicode码位为U+4E2D（10进制值为20013，2进制值为1001110_00101101）（加下划线是为了阅读方便）。转换成UTF-8编码时，先将低6位101101单独取出，加上10前缀後为10101101，即16进制的0xAD；再将中间6位111000取出，加上前缀10後为10111000，即16进制的0xB8；最後剩余3位100，补足成4位0100，再加上前缀1110後为11100100，即16进制的0xE4。因此汉字“中”在UTF-8编码规则中为3个字节，最高字节为0xE4，中间字节为0xB8，最低字节为0xAD。


## 附录
#### 关于UCS和Unicode
国际标准化组织（ISO）和多语言软件制造商组成的`Unicode`联盟都曾独立地创立统一的标准字符集。ISO开发了通用字符集（Universal Character Set, UCS）`ISO 10646`（或称`ISO/IEC 10646`），`Unicode`联盟则开发了`Unicode`。
由于意识到不需要两个不兼容的字符集，两个组织便合并了双方的工作成果，并为创立一个单一编码表而协同工作。从Unicode 2.0开始，Unicode采用了与ISO 10646-1相同的字库和字码；ISO也承诺，ISO 10646将不会替超出U+10FFFF的UCS-4编码赋值，以使得两者保持一致。

#### 字符集相关的网站
- [Unicode®字符百科](https://unicode-table.com/cn/)
- [汉字字符集编码查询](https://www.qqxiuzi.cn/bianma/zifuji.php)


### 参考文档
1. [字符集和字符编码的区别](https://www.cnblogs.com/xdyixia/p/9114145.html)
1. [字符集和字符编码（Charset & Encoding）](https://www.cnblogs.com/skynet/archive/2011/05/03/2035105.html)
1. [Unicode Consortium](https://home.unicode.org/basic-info/overview/)
1. [Unicode 和 UTF-8 有什么区别？——知乎](https://www.zhihu.com/question/23374078)
1. [utf-8和Unicode的区别](https://www.cnblogs.com/dhsz/p/7737480.html)
1. [Unicode与UTF-8的区别](https://blog.csdn.net/qq_36761831/article/details/82291166)
1. [彻底弄懂 Unicode 编码](https://blog.csdn.net/hezh1994/article/details/78899683)
1. [Unicode——百度百科](https://baike.baidu.com/item/Unicode/750500)
1. [ISO/IEC 8859——百度百科](https://baike.baidu.com/item/ISO%2FIEC%208859/916777)
1. [GB2312 编码](https://www.qqxiuzi.cn/zh/hanzi-gb2312-bianma.php)

